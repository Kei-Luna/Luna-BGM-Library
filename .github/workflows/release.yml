name: Auto Build and Release

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write
  
jobs:
  build-and-release:
    runs-on: windows-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore Luna-BGM-Library/Luna-BGM-Library.csproj

    - name: Build
      run: dotnet build Luna-BGM-Library/Luna-BGM-Library.csproj --configuration Release --no-restore

    - name: Publish
      run: dotnet publish Luna-BGM-Library/Luna-BGM-Library.csproj --configuration Release --output ./publish --self-contained false --runtime win-x64

    - name: Copy required files and folders
      run: |
        # Create required empty folders
        New-Item -ItemType Directory -Path "./publish/BGM" -Force
        New-Item -ItemType Directory -Path "./publish/download" -Force
        New-Item -ItemType Directory -Path "./publish/PCK" -Force
        
        # Copy Tools folder and games.json from source
        Copy-Item -Path "Luna-BGM-Library/Tools" -Destination "./publish/Tools" -Recurse -Force
        Copy-Item -Path "Luna-BGM-Library/games.json" -Destination "./publish/games.json" -Force
        
        # Remove unnecessary files to match local build
        $unnecessaryFiles = @(
            "*.pdb",
            "*.xml",
            "*.deps.json",
            "*.runtimeconfig.dev.json"
        )
        
        foreach ($pattern in $unnecessaryFiles) {
            Get-ChildItem "./publish" -Filter $pattern -Recurse | Remove-Item -Force
        }
        
        Write-Output "Required files and folders copied to publish directory"
        Write-Output "File count: $(Get-ChildItem './publish' -File -Recurse | Measure-Object | Select-Object -ExpandProperty Count)"
        Get-ChildItem "./publish" -Directory | ForEach-Object { Write-Output "Directory: $($_.Name)" }
        Get-ChildItem "./publish" -File | Where-Object { $_.Name -eq "games.json" } | ForEach-Object { Write-Output "File: $($_.Name)" }

    - name: Get latest release version
      id: get_version
      run: |
        $latestRelease = gh api repos/${{ github.repository }}/releases/latest 2>$null
        if ($LASTEXITCODE -eq 0) {
          $currentVersion = ($latestRelease | ConvertFrom-Json).tag_name
          Write-Output "Current version: $currentVersion"
          
          # Extract version number and increment
          if ($currentVersion -match 'v_(\d+)\.(\d+)') {
            $major = [int]$matches[1]
            $minor = [int]$matches[2]
            $newMinor = $minor + 1
            $newVersion = "v_$major.$newMinor"
          } else {
            $newVersion = "v_1.6"
          }
        } else {
          Write-Output "No previous releases found, starting with v_1.6"
          $newVersion = "v_1.6"
        }
        Write-Output "New version: $newVersion"
        echo "NEW_VERSION=$newVersion" >> $env:GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Get commit messages since last release
      id: get_commits
      run: |
        $latestRelease = gh api repos/${{ github.repository }}/releases/latest 2>$null
        if ($LASTEXITCODE -eq 0) {
          $lastReleaseTag = ($latestRelease | ConvertFrom-Json).tag_name
          Write-Output "Getting commits since $lastReleaseTag"
          $commits = git log --pretty=format:"- %s (%h)" $lastReleaseTag..HEAD
        } else {
          Write-Output "No previous release found, getting recent commits"
          $commits = git log --pretty=format:"- %s (%h)" -10
        }
        
        if ([string]::IsNullOrWhiteSpace($commits)) {
          $commits = "- Initial release"
        }
        
        # Convert to multiline string for GitHub output
        $commits = $commits -join "`n"
        Write-Output "Commits:"
        Write-Output $commits
        
        # Use here-string to handle multiline content
        $delimiter = "EOF_COMMITS_$(Get-Random)"
        echo "COMMITS<<$delimiter" >> $env:GITHUB_OUTPUT
        echo "$commits" >> $env:GITHUB_OUTPUT
        echo "$delimiter" >> $env:GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create ZIP archive
      run: |
        Compress-Archive -Path ./publish/* -DestinationPath "Luna-BGM-Library-${{ steps.get_version.outputs.NEW_VERSION }}.zip"

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_version.outputs.NEW_VERSION }}
        name: Release ${{ steps.get_version.outputs.NEW_VERSION }}
        body: |
          Automated build and release ${{ steps.get_version.outputs.NEW_VERSION }}
          
          ## Changes
          ${{ steps.get_commits.outputs.COMMITS }}
                    
          ## Requirements
          - Microsoft .NET 8.0 Runtime (Windows x64)
          - Download from: https://dotnet.microsoft.com/download/dotnet/8.0
        files: |
          Luna-BGM-Library-${{ steps.get_version.outputs.NEW_VERSION }}.zip
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}

  build-only:
    runs-on: windows-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore Luna-BGM-Library/Luna-BGM-Library.csproj

    - name: Build
      run: dotnet build Luna-BGM-Library/Luna-BGM-Library.csproj --configuration Release --no-restore

    - name: Test build
      run: dotnet publish Luna-BGM-Library/Luna-BGM-Library.csproj --configuration Release --output ./test-publish --self-contained true --runtime win-x64